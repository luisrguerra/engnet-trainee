<!-- carrecargar recursos do material dessign -->
<link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
<link rel="stylesheet" href="https://code.getmdl.io/1.3.0/material.indigo-pink.min.css">
<script defer src="https://code.getmdl.io/1.3.0/material.min.js"></script>

<!-- correção de resolução no smartphone -->
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- css -->
<style>
  @media only screen and (max-width: 800px) {
    div.corpo{
        margin-inline: 1em;
    }
  }
  @media only screen and (min-width: 800px) {
    div.corpo{
        margin-inline: 35%;
    }
  }
  #terminal{
    background-color:white;
    color:#282C34;
    border-color: #d4d9e3;
    border-style: solid;
    border-width: 1px;
    white-space: pre-line;
    padding: 1em 1em;
    border-radius: 8px;
  }
  #btnEnviar{
    float: right;
    margin-right:1em;
    border-radius: 4px;
  }

</style>

<!-- correção da margem -->
<div class="corpo">
<!-- pular linha -->
<br>

<h6>Chave:</h6>
<div style="width: 100%;" class="mdl-textfield mdl-js-textfield ">
   <input class="mdl-textfield__input" type="text" id="formkey">
   <label class="mdl-textfield__label"></label>
</div>

<!-- campo de input de texto -->
<h6>Prompt:</h6>
<div style="width: 100%;" class="mdl-textfield mdl-js-textfield ">
   <input class="mdl-textfield__input" type="text" id="formterminal">
   <label class="mdl-textfield__label">Oi</label>
</div>


<!-- botao enviar -->
<button id="btnEnviar" class="mdl-button mdl-js-button mdl-button--raised mdl-button--colored mdl-color--white mdl-color-text--black">
Enviar
</button>

<!-- pular linha -->
<br>
<br>
<br>
<br>

<!-- texto terminal -->
<p id=terminal >...</p>

</div>

<script type="module">
import openailib from 'https://cdn.jsdelivr.net/npm/openai@3.2.1/+esm';
console.log(openailib);
let apiKey = '';
const configuration = new openailib.Configuration({
  apiKey: apiKey,
});
const openai = new openailib.OpenAIApi(configuration);

const gptModelName = "gpt-3.5-turbo";

function initializeChat(behavior) {
  return [
    {role: "system", content: behavior}
  ];
}

async function completionsChatTextModel(promptText) {
  const messages = [
   {role: "user", content: promptText}
  ];

  return await openai.createChatCompletion({
      model: gptModelName,
      messages: messages,
      /*
      temperature: ,
      max_tokens: ,
      top_p: ,
      frequency_penalty: ,
      presence_penalty: ,
      */
    });
}

async function completionsChatTextModelV2(promptText, lastAnswer) {
  const messages = [
   {role: "assistant", content: lastAnswer},
   {role: "user", content: promptText}
  ];

  return await openai.createChatCompletion({
      model: gptModelName,
      messages: messages,
      /*
      temperature: ,
      max_tokens: ,
      top_p: ,
      frequency_penalty: ,
      presence_penalty: ,
      */
    });
}

async function completionsChatTextModelV3(messages) {
  return await openai.createChatCompletion({
      model: gptModelName,
      messages: messages,
      /*
      temperature: ,
      max_tokens: ,
      top_p: ,
      frequency_penalty: ,
      presence_penalty: ,
      */
    });
}

async function generateChatMessages(promptText) {
  const apiResponse = await completionsChatTextModel(promptText);
  return apiResponse.data.choices[0].message.content;
}

async function generateChatMessagesV2(promptText, lastAnswer) {
  const apiResponse = await completionsChatTextModelV2(promptText, lastAnswer);
  return apiResponse.data.choices[0].message.content;
}

async function generateChatMessagesV3(promptText, messages) {
  const prompt = {role: "user", content: promptText};
  messages.push(prompt);

  const apiResponse = await completionsChatTextModelV3(messages);
  const textResponse = apiResponse.data.choices[0].message.content;

  const assistantResponse = {role: "assistant", content: textResponse};
  messages.push(assistantResponse);

  return messages;
}

function lastMessage(messages){
  return messages[messages.length - 1].content;
}

const btnEnviar = document.getElementById('btnEnviar');

btnEnviar.addEventListener('click', async () => {
  apiKey = document.getElementById("formkey").value;
  console.log("chave: ",apiKey);
  const messages = initializeChat("You are a helpful assistant.");
  const userInput = document.getElementById("formterminal").value;
  const mensagesObject = generateChatMessagesV3(userInput,messages);
  console.log(messages);
  console.log(mensagesObject);
  const textResponse = lastMessage(mensagesObject);
});

</script>
